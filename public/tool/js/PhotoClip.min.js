/* PhotoClip v3.0.0 | (c) 2014-2016 BaiJunjie | GPL Licensed | Relying on the plug-in [iscroll-zoom.js] [hammer.js] [lrz.all.bundle.js] */
!function(t,i){"use strict";"function"==typeof define&&define.amd?define(["iscroll-zoom","hammer","lrz"],i):"object"==typeof exports?module.exports=i(require("iscroll-zoom"),require("hammer"),require("lrz")):t.PhotoClip=i(t.IScroll,t.Hammer,t.lrz)}(this,function(t,i,o){"use strict";function e(t,i){return this instanceof e?(this._$container=L(t),void(this._$container&&(this._options=u(!0,{},M,i),void 0===k&&this._options.errorMsg.noSupport&&alert(this._options.errorMsg.noSupport),this._init()))):new e(i)}function r(t,i,o,e){var r=t/o,n=i/e;return r>n?r:n}function n(t,i,o){i=i||0,o=o||0,S(t,k+"transform-origin",i+"px "+o+"px")}function a(t,i,o,e){i=i.toFixed(2)-0,o=o.toFixed(2)-0,S(t,k+"transform","translateZ(0) translate("+i+"px,"+o+"px) rotate("+e+"deg)")}function s(t,i,o,e,r,n){S(t,k+"transform"),S(t,k+"transition",k+"transform "+r+"ms"),a(t,i,o,e),setTimeout(function(){S(t,k+"transition",""),n()},r)}function h(t,i){var o=l(i),e=Math.sin(o),r=Math.cos(o);return{x:r*t.x-e*t.y,y:r*t.y+e*t.x}}function l(t){return t/180*Math.PI}function _(t,i,o,e){o=o||0,e=e||0;var r,n;return g([t,i],function(){r=t.getBoundingClientRect(),n=i.getBoundingClientRect()}),{x:n.left-r.left+o,y:n.top-r.top+e}}function c(t,i,o){i=i||0,o=o||0;var e;return g(t,function(){e=t.getBoundingClientRect()}),{x:i-e.left,y:o-e.top}}function u(){var t,i,o,e,r,n=arguments[0]||{},a=typeof n,s=Object.prototype.toString,h=1,l=arguments.length,_=!1;for("boolean"===a&&(_=n,n=arguments[h]||{},a=typeof n,h++),"object"!==a&&"function"!==a&&(n={}),h===l&&(n=this,h--);l>h;h++)if(null!=(t=arguments[h]))for(i in t)o=n[i],e=t[i],n!==e&&(_&&e&&(r="[object Array]"===s.call(e))||"object"==typeof e?(r?(r=!1,o=o&&"[object Array]"===s.call(o)?o:[]):o=o&&"object"==typeof o?o:{},n[i]=u(_,o,e)):void 0!==e&&(n[i]=e));return n}function p(t,i){if("string"==typeof i){var o=t[i];i=t,t=o}if("function"!=typeof t)return void 0;var e=Array.prototype.slice,r=e.call(arguments,2),n=function(){return t.apply(i||this,r.concat(e.call(arguments)))};return n.guid=t.guid=t.guid||H++,n}function g(t,i,o){"object"!=typeof t&&(t=[]),"undefined"==typeof t.length&&(t=[t]);for(var e,r=[],n=[],a=0;e=t[a++];)for(;e instanceof HTMLElement;){var s=e.nodeName;if(!e.getClientRects().length){r.push(e),n.push(e.style.display);var h=x[s];if(!h){var l=document.createElement(s);document.body.appendChild(l),h=window.getComputedStyle(l).display,l.parentNode.removeChild(l),"none"===h&&(h="block"),x[s]=h}e.style.display=h}if("BODY"===s)break;e=e.parentNode}"function"==typeof i&&i.call(o||this);for(var _=r.length;_--;)r.pop().style.display=n.pop()}function d(t){return/%$/.test(t+"")}function m(t){return"number"==typeof t}function f(t){return"[object Array]"===Object.prototype.toString.call(t)}function y(t,i,o,e){var r=document.createElement("DIV");if("object"==typeof i&&(e=i,i=null),"object"==typeof o&&(e=o,o=null),"object"==typeof e)for(var n in e)r.style[n]=e[n];return i&&(r.className=i),o&&(r.id=o),t.appendChild(r),r}function v(t){t.parentNode&&t.parentNode.removeChild(t)}function L(t,i){return t instanceof HTMLElement?t:t&&"string"==typeof t?("string"==typeof i&&(i=document.querySelector(i)),i instanceof HTMLElement||(i=document),i.querySelector(t)):null}function $(t,i,o){if("object"==typeof i){for(var e in i)t[e]=i[e];return t}return void 0===o?t[i]:(t[i]=o,t)}function S(t,i,o){if("object"==typeof i){for(var e in i)o=i[e],m(o)&&(o+="px"),t.style[e]=o;return t}return void 0===o?window.getComputedStyle(t)[i]:(m(o)&&(o+="px"),t.style[i]=o,t)}function z(t){var i=document.documentElement;if(t in i.style)return"";for(var o,e=t.charAt(0).toUpperCase()+t.substr(1),r=["Webkit","Moz","ms","O"],n=0;o=r[n++];)if(o+e in i.style)return"-"+o.toLowerCase()+"-"}var b=!!navigator.userAgent.match(/mobile/i),R=z("transition"),k=z("transform"),w=function(){},M={size:[100,100],adaptive:"",outputSize:[0,0],outputType:"jpg",outputQuality:.8,view:"",file:"",ok:"",img:"",loadStart:w,loadComplete:w,loadError:w,done:w,fail:w,lrzOption:{width:void 0,height:void 0,quality:.7},style:{maskColor:"rgba(0,0,0,.5)",maskBorder:"2px dashed #ddd",jpgFillColor:"#fff"},errorMsg:{noSupport:"您的浏览器版本过于陈旧，无法支持裁图功能，请更换新的浏览器！",notFile:"您的浏览器不支持 HTML5 的 FileReader API，因此不能使用 file 控件读取图片！",imgError:"不支持该图片格式，请选择常规格式的图片文件！",imgHandleError:"图片处理失败！请更换其它图片尝试。",imgLoadError:"图片读取失败！请更换其它图片尝试。",noImg:"没有可裁剪的图片！",clipError:"截图失败！当前图片源文件可能存在跨域问题，请确保图片与应用同源。如果您是在本地环境下执行本程序，请更换至服务器环境。"}},C=e.prototype;C.constructor=e,C._init=function(){var t=this._options;m(t.size)?t.size=[t.size,t.size]:f(t.size)?((!m(t.size[0])||t.size[0]<=0)&&(t.size[0]=M.size[0]),(!m(t.size[1])||t.size[1]<=0)&&(t.size[1]=M.size[1])):t.size=u({},M.size),m(t.outputSize)?t.outputSize=[t.outputSize,0]:f(t.outputSize)?((!m(t.outputSize[0])||t.outputSize[0]<0)&&(t.outputSize[0]=M.outputSize[0]),(!m(t.outputSize[1])||t.outputSize[1]<0)&&(t.outputSize[1]=M.outputSize[1])):t.outputSize=u({},M.outputSize),t.outputType="jpg"===t.outputType?"image/jpeg":"image/png",f(t.adaptive)&&(this._widthIsPercent=t.adaptive[0]&&d(t.adaptive[0])?t.adaptive[0]:!1,this._heightIsPercent=t.adaptive[1]&&d(t.adaptive[1])?t.adaptive[1]:!1),this._outputWidth=t.outputSize[0],this._outputHeight=t.outputSize[1],this._canvas=document.createElement("canvas"),this._fileReader=null,this._iScroll=null,this._hammerManager=null,this._clipWidth=0,this._clipHeight=0,this._clipSizeRatio=1,this._$img=null,this._imgLoading=!1,this._imgLoaded=!1,this._containerWidth=0,this._containerHeight=0,this._$clipLayer=null,this._$moveLayer=null,this._$rotationLayer=null,this._$view=null,this._$file=null,this._$ok=null,this._$mask=null,this._$mask_left=null,this._$mask_right=null,this._$mask_right=null,this._$mask_bottom=null,this._$clip_frame=null,this._atRotation=!1,this._rotationLayerWidth=0,this._rotationLayerHeight=0,this._rotationLayerX=0,this._rotationLayerY=0,this._curAngle=0,this._initProxy(),this._initElements(),this._initScroll(),this._initRotationEvent(),this._initFile(),this._resize(),window.addEventListener("resize",this._resize),(this._$ok=L(t.ok))&&this._$ok.addEventListener("click",this._clipImg),this._options.img&&this._createImg(this._options.img)},C._initElements=function(){var t=this._$container,i=t.style,o={};o["user-select"]=i["user-select"],o.overflow=i.overflow,o.position=i.position,this._containerOriginStyle=o,S(t,{"user-select":"none",overflow:"hidden"}),"static"===S(t,"position")&&S(t,"position","relative"),this._$clipLayer=y(t,"photo-clip-layer",{position:"absolute",left:"50%",top:"50%"}),this._$moveLayer=y(this._$clipLayer,"photo-clip-move-layer"),this._$rotationLayer=y(this._$moveLayer,"photo-clip-rotation-layer");var e=this._$mask=y(t,"photo-clip-mask",{position:"absolute",left:0,top:0,width:"100%",height:"100%","pointer-events":"none"}),r=this._options,n=r.style.maskColor,a=r.style.maskBorder;this._$mask_left=y(e,"photo-clip-mask-left",{position:"absolute",left:0,right:"50%",top:"50%",bottom:"50%",width:"auto","background-color":n}),this._$mask_right=y(e,"photo-clip-mask-right",{position:"absolute",left:"50%",right:0,top:"50%",bottom:"50%","background-color":n}),this._$mask_top=y(e,"photo-clip-mask-top",{position:"absolute",left:0,right:0,top:0,bottom:"50%","background-color":n}),this._$mask_bottom=y(e,"photo-clip-mask-bottom",{position:"absolute",left:0,right:0,top:"50%",bottom:0,"background-color":n}),this._$clip_frame=y(e,"photo-clip-area",{border:a,position:"absolute",left:"50%",top:"50%"});var s=this._$view=L(r.view);if(s){var i=s.style,h={};h["background-repeat"]=i["background-repeat"],h["background-position"]=i["background-position"],h["background-size"]=i["background-size"],this._viewOriginStyle=h,S(s,{"background-repeat":"no-repeat","background-position":"center","background-size":"contain"})}},C._initScroll=function(){this._iScroll=new t(this._$clipLayer,{zoom:!0,scrollX:!0,scrollY:!0,freeScroll:!0,mouseWheel:!0,wheelAction:"zoom"})},C._refreshScroll=function(t){t=t||0;var i=this._rotationLayerWidth,o=this._rotationLayerHeight;i&&o?(this._iScroll.options.zoomMin=r(this._clipWidth,this._clipHeight,i,o),this._iScroll.options.zoomMax=Math.max(1,this._iScroll.options.zoomMin),this._iScroll.options.zoomStart=Math.min(this._iScroll.options.zoomMax,r(this._containerWidth,this._containerHeight,i,o))):(this._iScroll.options.zoomMin=1,this._iScroll.options.zoomMax=1,this._iScroll.options.zoomStart=1),S(this._$moveLayer,{width:i,height:o}),this._$clipLayer.appendChild(this._$moveLayer),this._iScroll.refresh(t)},C._resetScroll=function(t,i){t=t||0,i=i||0,this._rotationLayerWidth=t,this._rotationLayerHeight=i,this._rotationLayerX=0,this._rotationLayerY=0,this._curAngle=0,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle),S(this._$rotationLayer,{width:t,height:i}),this._refreshScroll();var o=this._iScroll.scale,e=.5*(this._clipWidth-t*o),r=.5*(this._clipHeight-i*o);this._iScroll.scrollTo(e,r),this._iScroll.zoom(this._iScroll.options.zoomStart,void 0,void 0,0)},C._initRotationEvent=function(){if(b){this._hammerManager=new i.Manager(this._$moveLayer),this._hammerManager.add(new i.Rotate);var t,o,e=this;this._hammerManager.on("rotatestart",function(i){e._atRotation||(t=i.rotation-e._curAngle,e._rotationLayerRotateReady(i.center))}),this._hammerManager.on("rotatemove",function(i){e._atRotation||(o=i.rotation-t,e._rotationLayerRotate(o))}),this._hammerManager.on("rotateend rotatecancel",function(){if(!e._atRotation){var t=o%360;0>t&&(t+=360),10>t?o+=-t:t>80&&100>t?o+=90-t:t>170&&190>t?o+=180-t:t>260&&280>t?o+=270-t:t>350&&(o+=360-t),e._rotationLayerRotateFinish(o,200)}})}else this._$moveLayer.addEventListener("dblclick",this._rotateCW90)},C._rotateCW90=function(t){this._rotateBy(90,200,{x:t.clientX,y:t.clientY})},C._rotateBy=function(t,i,o){this._atRotation||this._rotateTo(this._curAngle+t,i,o)},C._rotateTo=function(t,i,o){this._atRotation||(this._rotationLayerRotateReady(o),i&&m(i)||this._rotationLayerRotate(t),this._rotationLayerRotateFinish(t,i))},C._rotationLayerRotateReady=function(t){var i,o=this._iScroll.scale;i=t?c(this._$rotationLayer,t.x,t.y):_(this._$rotationLayer,this._$clipLayer,.5*this._clipWidth,.5*this._clipHeight),i.x/=o,i.y/=o;var e={x:i.x-this._rotationLayerX,y:i.y-this._rotationLayerY},r=h(e,-this._curAngle),s=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,r.x,r.y);var l=this._$rotationLayer.getBoundingClientRect();this._rotationLayerX-=(l.left-s.left)/o,this._rotationLayerY-=(l.top-s.top)/o,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle)},C._rotationLayerRotate=function(t){this._curAngle=t,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t)},C._rotationLayerRotateFinish=function(t,i){if(a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t),t!==this._curAngle&&i&&m(i)&&void 0!==R){var o=this._iScroll.scale,e=o<this._iScroll.options.zoomMin||o>this._iScroll.options.zoomMax;if(e)var r=this._$rotationLayer.getBoundingClientRect();var n=this;this._atRotation=!0,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle),s(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,t,i,function(){if(n._atRotation=!1,e){var i=n._$rotationLayer.getBoundingClientRect();n._iScroll.scale=o/r.width*i.width}n._rotateFinishUpdataElem(t)})}else this._rotateFinishUpdataElem(t)},C._rotateFinishUpdataElem=function(t){var i=this._$rotationLayer.getBoundingClientRect();n(this._$rotationLayer,0,0);var o=this._$rotationLayer.getBoundingClientRect();a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,0);var e=this._$rotationLayer.getBoundingClientRect(),r=this._$moveLayer.getBoundingClientRect(),s=r.left-i.left,h=r.top-i.top;this._iScroll.scrollTo(this._iScroll.x-s,this._iScroll.y-h);var l=this._iScroll.scale;this._rotationLayerWidth=i.width/l,this._rotationLayerHeight=i.height/l,this._rotationLayerX=(e.left-o.left)/l,this._rotationLayerY=(e.top-o.top)/l,this._curAngle=t%360,a(this._$rotationLayer,this._rotationLayerX,this._rotationLayerY,this._curAngle),this._refreshScroll(200);var _=Math.max(this._iScroll.options.zoomMin,Math.min(this._iScroll.options.zoomMax,l));_!==l&&(this._iScroll.zoom(_,void 0,void 0,200),s=s/l*_,h=h/l*_),this._iScroll.startX-=s,this._iScroll.startY-=h},C._initFile=function(){var t=this._options,i=t.errorMsg;if(this._$file=L(t.file)){if(!window.FileReader)return void(i.notFile&&alert(i.notFile));b||$(this._$file,"accept","image/jpeg, image/x-png, image/gif"),this._fileReader=new FileReader,this._$file.addEventListener("change",this._fileOnChangeHandle)}},C._fileOnChangeHandle=function(t){var i=this,e=this._options,r=e.errorMsg,n=t.target.files;if(n.length){var a=n[0];return/image\/\w+/.test(a.type)?(this._imgLoading||(this._imgLoading=!0,e.loadStart.call(this,a)),this._fileReader.onprogress=function(t){console.log((t.loaded/t.total*100).toFixed()+"%")},this._fileReader.onload=function(){o(a,e.lrzOption).then(function(t){i._createImg(t.base64)}).catch(function(t){e.loadError.call(i,r.imgHandleError,t),i._imgLoading=!1})},this._fileReader.onerror=function(t){e.loadError.call(i,r.imgLoadError,t),i._imgLoading=!1},this._fileReader.readAsDataURL(a),void 0):(e.loadError.call(this,r.imgError),!1)}},C._clearImg=function(){this._$img&&(this._$img.onload=null,this._$img.onerror=null,v(this._$img),this._$img=null)},C._createImg=function(t){var i=this,o=this._options,e=o.errorMsg;this._clearImg(),this._$img=new Image,S(this._$img,{"user-select":"none","pointer-events":"none"}),this._imgLoading||(this._imgLoading=!0,o.loadStart.call(this,this._$img)),this._imgLoaded=!1,this._$img.onload=function(){i._imgLoaded=!0,i._imgLoading=!1,o.loadComplete.call(i,this),i._$rotationLayer.appendChild(this),g([this,i._$moveLayer],function(){i._resetScroll(this.naturalWidth,this.naturalHeight)},this)},this._$img.onerror=function(t){o.loadError.call(i,e.imgLoadError,t),i._imgLoading=!1},$(this._$img,"src",t)},C._clipImg=function(){var t=this._options,i=t.errorMsg;if(!this._imgLoaded)return void t.fail.call(this,i.noImg);var o=_(this._$rotationLayer,this._$clipLayer),e=this._iScroll.scale,r=1,n=1,a=this._canvas.getContext("2d");this._outputWidth||this._outputHeight?(this._canvas.width=this._outputWidth,this._canvas.height=this._outputHeight,r=this._outputWidth/this._clipWidth*e,n=this._outputHeight/this._clipHeight*e):(this._canvas.width=this._clipWidth/e,this._canvas.height=this._clipHeight/e),a.clearRect(0,0,this._canvas.width,this._canvas.height),a.fillStyle=t.style.jpgFillColor,a.fillRect(0,0,this._canvas.width,this._canvas.height),a.save(),a.scale(r,n),a.translate(this._rotationLayerX-o.x/e,this._rotationLayerY-o.y/e),a.rotate(this._curAngle*Math.PI/180),a.drawImage(this._$img,0,0),a.restore();try{var s=this._canvas.toDataURL(t.outputType,t.outputQuality);return this._$view&&S(this._$view,"background-image","url("+s+")"),t.done.call(this,s),s}catch(h){t.fail.call(this,i.clipError,h)}},C._resize=function(t,i){g(this._$container,function(){this._containerWidth=this._$container.offsetWidth,this._containerHeight=this._$container.offsetHeight},this);var o=this._options.size,e=this._clipWidth,r=this._clipHeight;if(m(t)&&(o[0]=t),m(i)&&(o[1]=i),this._widthIsPercent||this._heightIsPercent){var n=o[0]/o[1];this._widthIsPercent&&(this._clipWidth=this._containerWidth/100*parseFloat(this._widthIsPercent),this._heightIsPercent||(this._clipHeight=this._clipWidth/n)),this._heightIsPercent&&(this._clipHeight=this._containerHeight/100*parseFloat(this._heightIsPercent),this._widthIsPercent||(this._clipWidth=this._clipHeight*n))}else this._clipWidth=o[0],this._clipHeight=o[1];var a=this._clipWidth,s=this._clipHeight;if(this._clipSizeRatio=a/s,this._outputWidth&&!this._outputHeight&&(this._outputHeight=this._outputWidth/this._clipSizeRatio),this._outputHeight&&!this._outputWidth&&(this._outputWidth=this._outputHeight*this._clipSizeRatio),S(this._$clipLayer,{width:a,height:s,"margin-left":-a/2,"margin-top":-s/2}),S(this._$mask_left,{"margin-right":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),S(this._$mask_right,{"margin-left":a/2,"margin-top":-s/2,"margin-bottom":-s/2}),S(this._$mask_top,{"margin-bottom":s/2}),S(this._$mask_bottom,{"margin-top":s/2}),S(this._$clip_frame,{width:a,height:s}),S(this._$clip_frame,k+"transform","translate(-50%, -50%)"),a!==e||s!==r){this._refreshScroll();var h=this._iScroll.scale,l=.5*(a-e)*h,_=.5*(s-r)*h;this._iScroll.scrollBy(l,_);var c=Math.max(this._iScroll.options.zoomMin,Math.min(this._iScroll.options.zoomMax,h));c!==h&&this._iScroll.zoom(c,void 0,void 0,0)}},C._initProxy=function(){this._fileOnChangeHandle=p(this,"_fileOnChangeHandle"),this._rotateCW90=p(this,"_rotateCW90"),this._resize=p(this,"_resize"),this._clipImg=p(this,"_clipImg"),this.size=p(this,"size"),this.load=p(this,"load"),this.rotateBy=p(this,"rotateBy"),this.rotateTo=p(this,"rotateTo"),this.clip=p(this,"clip"),this.destroy=p(this,"destroy")},C.size=function(t,i){return this._resize(t,i),this},C.load=function(t){return this._createImg(t),this},C.clear=function(){return this._clearImg(),this._resetScroll(),this._$file.value="",this},C.rotateBy=function(t,i,o){return this._rotateBy(t,i,o),this},C.rotateTo=function(t,i,o){return this._rotateTo(t,i,o),this},C.clip=function(){return this._clipImg()},C.destroy=function(){window.removeEventListener("resize",this._resize),this._$container.removeChild(this._$clipLayer),this._$container.removeChild(this._$mask),S(this._$container,this._containerOriginStyle),this._$view&&S(this._$view,this._viewOriginStyle),this._fileReader&&(this._fileReader.onprogress=null,this._fileReader.onload=null,this._fileReader.onerror=null),this._iScroll&&this._iScroll.destroy(),this._hammerManager?(this._hammerManager.off("rotatemove"),this._hammerManager.off("rotateend"),this._hammerManager.destroy()):this._$moveLayer.removeEventListener("dblclick",this._rotateCW90),this._$img&&(this._$img.onload=null,this._$img.onerror=null),this._$file&&this._$file.removeEventListener("change",this._fileOnChangeHandle),this._$ok&&this._$ok.removeEventListener("click",this._clipImg);for(var t in this)delete this[t];this.__proto__=Object.prototype};var H=0,x={};return e});